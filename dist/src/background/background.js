(function(){"use strict";const s=new Map;chrome.downloads.onChanged.addListener(r=>{var n,a,t,o;const e=s.get(r.id);e&&(((n=r.state)==null?void 0:n.current)==="complete"?(e.resolve(),s.delete(r.id),c(e.tabId,{action:"file-complete",downloadId:r.id})):((a=r.state)==null?void 0:a.current)==="interrupted"&&(e.reject(((t=r.error)==null?void 0:t.current)||"Interrupted"),s.delete(r.id),c(e.tabId,{action:"file-error",downloadId:r.id,reason:((o=r.error)==null?void 0:o.current)||"Unknown error"})))});function c(r,e){r<0||chrome.tabs.sendMessage(r,e,()=>{chrome.runtime.lastError})}chrome.runtime.onMessage.addListener((r,e,n)=>{var a;if(r.action==="download"){const{url:t,filename:o}=r,i=(a=e.tab)==null?void 0:a.id;return typeof i!="number"?(console.warn("No tabId for download status"),n({status:"error",reason:"No tabId"}),!0):(d(t,o,i).then(()=>n({status:"started"})).catch(u=>n({status:"error",reason:u})),!0)}return!1});async function d(r,e,n,a=3){let t=1;for(;t<=a;)try{await f(r,e,n);return}catch(o){if(console.warn(`Попытка ${t}/${a} не удалась:`,o),t===a)throw c(n,{action:"file-error",error:o instanceof Error?o.message:String(o)}),o;await new Promise(i=>setTimeout(i,1e3*t)),t++}}function f(r,e,n){return new Promise((a,t)=>{chrome.downloads.download({url:r,filename:e,conflictAction:"overwrite",saveAs:!1},o=>{var i;if(chrome.runtime.lastError||typeof o!="number"){const u=((i=chrome.runtime.lastError)==null?void 0:i.message)||"Failed to start download";t(new Error(u));return}s.set(o,{tabId:n,resolve:a,reject:t})})})}})();
